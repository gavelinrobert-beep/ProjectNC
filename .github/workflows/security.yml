name: Security Scanning

on:
  schedule:
    # Run weekly on Mondays at 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    # Allow manual triggering
  push:
    branches:
      - master
      - main

jobs:
  dependency-scan:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Set up Node.js 20.x
      uses: actions/setup-node@v4
      with:
        node-version: '20'

    - name: Scan Python dependencies with Safety
      run: |
        pip install safety
        cd backend
        # Create a report
        safety check --json --output safety-report.json || true
        safety check || echo "âš ï¸ Python dependency vulnerabilities found"

    - name: Scan Node.js dependencies with npm audit
      run: |
        cd frontend
        npm audit --json > npm-audit-report.json || true
        npm audit || echo "âš ï¸ Node.js dependency vulnerabilities found"

    - name: Upload Python security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: python-safety-report
        path: backend/safety-report.json

    - name: Upload Node.js security report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: nodejs-audit-report
        path: frontend/npm-audit-report.json

  sast-scan:
    runs-on: ubuntu-latest
    permissions:
      security-events: write
      contents: read
      actions: read

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: python, javascript

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

    - name: Run Bandit SAST for Python
      run: |
        pip install bandit[toml]
        cd backend
        bandit -r app -f json -o bandit-sast-report.json || true
        bandit -r app

    - name: Upload Bandit SAST report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-sast-report
        path: backend/bandit-sast-report.json

  create-issues:
    needs: [dependency-scan, sast-scan]
    runs-on: ubuntu-latest
    if: failure()
    
    steps:
    - name: Create issue for critical vulnerabilities
      uses: actions/github-script@v7
      with:
        script: |
          const title = `ðŸ”’ Security Scan Alert - ${new Date().toISOString().split('T')[0]}`;
          const body = `## Security Vulnerabilities Detected
          
          The automated security scan has detected potential vulnerabilities in the codebase.
          
          ### Details
          - **Workflow Run**: [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - **Branch**: ${{ github.ref }}
          - **Commit**: ${{ github.sha }}
          
          ### Action Required
          1. Review the workflow logs for detailed vulnerability information
          2. Download the security reports from the workflow artifacts
          3. Assess the severity of each vulnerability
          4. Update dependencies or apply patches as needed
          5. Re-run the security scan to verify fixes
          
          ### Reports Available
          - Python Safety Report (Python dependencies)
          - npm Audit Report (Node.js dependencies)
          - Bandit SAST Report (Python static analysis)
          - CodeQL Analysis (Multi-language SAST)
          
          **Priority**: High
          **Automated Issue**: This issue was created automatically by the security scanning workflow.`;
          
          // Check if a similar issue already exists
          const issues = await github.rest.issues.listForRepo({
            owner: context.repo.owner,
            repo: context.repo.repo,
            state: 'open',
            labels: 'security,automated'
          });
          
          const existingIssue = issues.data.find(issue => 
            issue.title.includes('Security Scan Alert') && 
            new Date(issue.created_at) > new Date(Date.now() - 7 * 24 * 60 * 60 * 1000)
          );
          
          if (!existingIssue) {
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated', 'vulnerability']
            });
          } else {
            console.log('Similar security issue already exists, skipping creation');
          }
