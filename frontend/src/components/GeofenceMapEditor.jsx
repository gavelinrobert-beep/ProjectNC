import React,{useMemo,useRef,useState} from 'react'
import { MapContainer, TileLayer, Polygon, Marker, Popup, useMapEvents } from 'react-leaflet'
import L from 'leaflet'
const defaultCenter=[62.3901,17.3062]
function DraggableVertex({index,pos,onDragEnd}){const icon=useMemo(()=>L.divIcon({className:'vertex-handle',html:'',iconSize:[10,10]}),[]);const ref=useRef(null);return(<Marker position={pos} icon={icon} draggable eventHandlers={{dragend:()=>{const m=ref.current;if(!m)return;const p=m.getLatLng();onDragEnd(index,[p.lat,p.lng])}}} ref={ref}/>) }
function ClickHandler({onClick,enabled}){useMapEvents({click(e){if(!enabled)return;onClick([e.latlng.lat,e.latlng.lng])}});return null}
export default function GeofenceMapEditor({geofences=[],draft=[],setDraft,showExisting=true}){const [isDrawing,setIsDrawing]=useState(true);const localDraft=draft||[];function addPoint(pt){setDraft([...(localDraft||[]),pt])}function removeLast(){if((localDraft||[]).length)setDraft(localDraft.slice(0,-1))}function moveVertex(i,pt){const next=[...localDraft];next[i]=pt;setDraft(next)}return(<div style={{height:'70vh',width:'100%'}}><div className='map-toolbar toolbar' style={{margin:'6px 0'}}><button className='btn' onClick={()=>setIsDrawing(!isDrawing)}>{isDrawing?'Stoppa ritning':'Rita'}</button><button className='btn' onClick={removeLast} disabled={!localDraft.length}>Ã…ngra</button><span className='muted'>Punkter: {localDraft.length}</span></div><MapContainer center={defaultCenter} zoom={11} style={{height:'100%',width:'100%',borderRadius:12,zIndex:1,cursor:isDrawing?'crosshair':'grab'}} doubleClickZoom={false}><TileLayer url='https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png' attribution='&copy; OpenStreetMap contributors'/><ClickHandler enabled={isDrawing} onClick={addPoint}/>{showExisting&&geofences.map(g=>(Array.isArray(g.polygon)&&g.polygon.length>2?<Polygon key={g.id} positions={g.polygon} pathOptions={{color:'#b89b52'}}><Popup><b>{g.name}</b></Popup></Polygon>:null))}{localDraft.length>2&&<Polygon positions={localDraft} pathOptions={{color:'#3aa86f'}}/>}{localDraft.map((p,i)=>(<DraggableVertex key={i} index={i} pos={p} onDragEnd={moveVertex}/>))}</MapContainer></div>)}
